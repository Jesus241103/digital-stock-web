<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Digital Stock - Dashboard">
    <title>Dashboard | Digital Stock</title>

    <!-- Estilos -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layout.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Estilos específicos del dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .charts-grid,
        .second-charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .second-charts-grid {
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 1000px) {

            .charts-grid,
            .second-charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .tables-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-lg);
        }

        @media (max-width: 1000px) {
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }

        .card-subtitle {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        .alert-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: rgba(245, 158, 11, 0.1);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--color-warning);
        }

        .alert-item.danger {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: var(--color-danger);
        }

        .alert-product {
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .alert-stock {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        .mini-table {
            width: 100%;
        }

        .mini-table th,
        .mini-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--font-size-sm);
        }

        /* Estilos específicos para el widget de dólar */
        .dollar-widget {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            color: #2ecc71;
            transition: all 0.3s ease;
        }

        .dollar-widget:hover {
            background: rgba(34, 197, 94, 0.15);
            transform: translateY(-1px);
        }

        .dollar-widget.error {
            background: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .dollar-icon {
            font-size: 1.4rem;
        }

        .dollar-info {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .dollar-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            opacity: 0.8;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .dollar-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Estilo mejorado para el select de año */
        .chart-year-select {
            background: var(--color-bg-input);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            transition: border-color var(--transition-fast);
            appearance: none;
            /* Quitar estilo por defecto */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }

        .chart-year-select:focus {
            border-color: var(--color-accent-primary);
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Sidebar se inyecta vía JS (layout.js) -->

        <!-- Contenido Principal -->
        <main class="main-content">
            <header class="main-header">
                <button class="mobile-menu-btn" id="menuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="page-title-section">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="page-breadcrumb">
                        <a href="#">Inicio</a>
                        <span>/</span>
                        <span>Dashboard</span>
                        <span class="text-muted mx-2">|</span>
                        <span id="currentDate"></span>
                    </div>
                </div>
                <div class="header-actions">
                    <!-- Widget de Tasa de Cambio (Reemplaza botón nueva compra) -->
                    <div id="dollarWidget" class="dollar-widget" style="display: none;">
                        <i class="fas fa-sack-dollar dollar-icon"></i>
                        <div class="dollar-info">
                            <span class="dollar-label">Tasa BCV</span>
                            <span class="dollar-amount" id="dollarValue">--.--</span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- KPIs -->
                <div class="grid-cols-4" style="margin-bottom: var(--spacing-xl);">
                    <div class="kpi-card info animate-fade-in" style="animation-delay: 0.1s;">
                        <div class="kpi-icon"><i class="fas fa-box"></i></div>
                        <div class="kpi-value" id="kpiProducts">-</div>
                        <div class="kpi-label">Productos</div>
                    </div>
                    <div class="kpi-card success animate-fade-in" style="animation-delay: 0.2s;">
                        <div class="kpi-icon"><i class="fas fa-users"></i></div>
                        <div class="kpi-value" id="kpiClients">-</div>
                        <div class="kpi-label">Clientes</div>
                    </div>
                    <div class="kpi-card warning animate-fade-in" style="animation-delay: 0.3s;">
                        <div class="kpi-icon"><i class="fas fa-truck"></i></div>
                        <div class="kpi-value" id="kpiProviders">-</div>
                        <div class="kpi-label">Proveedores</div>
                    </div>
                    <div class="kpi-card danger animate-fade-in" style="animation-delay: 0.4s;">
                        <div class="kpi-icon"><i class="fas fa-coins"></i></div>
                        <div class="kpi-value" id="kpiInventory">-</div>
                        <div class="kpi-label">Valor Inventario ($)</div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="charts-grid">
                    <div class="card animate-slide-up">
                        <div class="card-header"
                            style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 class="card-title">Transacciones del Mes</h3>
                                <span class="card-subtitle">Compras vs Ventas</span>
                            </div>
                            <select id="chartYear" class="chart-year-select">
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="transactionsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card animate-slide-up" style="animation-delay: 0.1s;">
                        <div class="card-header">
                            <h3 class="card-title">Alertas de Stock</h3>
                            <span class="card-subtitle">Productos bajo mínimo</span>
                        </div>
                        <div class="card-body">
                            <div class="alert-list" id="alertList">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos Secundarios -->
                <div class="charts-grid second-charts-grid">
                    <div class="card animate-slide-up" style="animation-delay: 0.2s;">
                        <div class="card-header">
                            <h3 class="card-title">Top 5 Productos</h3>
                            <span class="card-subtitle">Más vendidos históricamente</span>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card animate-slide-up" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3 class="card-title">Niveles de Stock</h3>
                            <span class="card-subtitle">Distribución por estado</span>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="stockDistChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tablas de últimas transacciones -->
                <div class="tables-grid">
                    <div class="card animate-slide-up" style="animation-delay: 0.2s;">
                        <div class="card-header">
                            <h3 class="card-title">Últimas Compras</h3>
                            <a href="purchases.html" class="btn btn-ghost btn-sm">Ver todas</a>
                        </div>
                        <div class="card-body p-0">
                            <table class="table mini-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Proveedor</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                    </tr>
                                </thead>
                                <tbody id="recentPurchases">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card animate-slide-up" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3 class="card-title">Últimas Ventas</h3>
                            <a href="sales.html" class="btn btn-ghost btn-sm">Ver todas</a>
                        </div>
                        <div class="card-body p-0">
                            <table class="table mini-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                    </tr>
                                </thead>
                                <tbody id="recentSales">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/layout.js"></script>
    <script>
        // Layout.js maneja la autenticación y UI global

        // Fecha actual
        document.getElementById('currentDate').textContent = Utils.formatDate(new Date(), 'long');

        // Variables de gráficos
        let transactionsChart;
        let topProductsChart;
        let stockDistChart;

        function initCharts() {
            // 1. Transacciones
            const ctx1 = document.getElementById('transactionsChart').getContext('2d');
            transactionsChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    datasets: [
                        { label: 'Compras', data: [], backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 4 },
                        { label: 'Ventas', data: [], backgroundColor: 'rgba(34, 197, 94, 0.8)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { color: '#94a3b8' } } },
                    scales: {
                        x: { grid: { color: 'rgba(45, 45, 74, 0.3)' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { color: 'rgba(45, 45, 74, 0.3)' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });

            // 2. Top Productos (Doughnut)
            const ctx2 = document.getElementById('topProductsChart').getContext('2d');
            topProductsChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(6, 182, 212, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
                }
            });

            // 3. Distribución Stock (Pie)
            const ctx3 = document.getElementById('stockDistChart').getContext('2d');
            stockDistChart = new Chart(ctx3, {
                type: 'pie',
                data: {
                    labels: ['Normal', 'Bajo', 'Exceso'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)', // Normal (Verde)
                            'rgba(239, 68, 68, 0.8)', // Bajo (Rojo)
                            'rgba(245, 158, 11, 0.8)'  // Exceso (Naranja)
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
                }
            });
        }

        // Cargar datos del dashboard (KPIs y Tablas)
        async function loadDashboardData() {
            try {
                const result = await API.reports.getDashboard();

                if (result.success) {
                    const data = result.data;

                    // KPIs
                    document.getElementById('kpiProducts').textContent = data.counts.productos;
                    document.getElementById('kpiClients').textContent = data.counts.clientes;
                    document.getElementById('kpiProviders').textContent = data.counts.proveedores;
                    document.getElementById('kpiInventory').textContent = Utils.formatCurrency(data.inventoryValue);

                    // Alertas de stock bajo
                    const alertList = document.getElementById('alertList');
                    if (data.lowStockProducts.length > 0) {
                        alertList.innerHTML = data.lowStockProducts.map(p => `
                            <div class="alert-item ${p.cantidad === 0 ? 'danger' : ''}">
                                <div>
                                    <div class="alert-product">${Utils.escapeHtml(p.nombre)}</div>
                                    <div class="alert-stock">Código: ${p.codigo}</div>
                                </div>
                                <div class="badge ${p.cantidad === 0 ? 'badge-danger' : 'badge-warning'}">
                                    ${p.cantidad} / ${p.min}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        alertList.innerHTML = `<div class="empty-state" style="padding: var(--spacing-lg);"><i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i><p class="text-muted mt-2">Sin alertas de stock</p></div>`;
                    }

                    // Últimas compras
                    const purchasesBody = document.getElementById('recentPurchases');
                    purchasesBody.innerHTML = data.recentPurchases.map(p => `
                        <tr><td>#${p.id}</td><td>${Utils.escapeHtml(p.proveedor || 'N/A')}</td><td>${Utils.formatDate(p.fecha)}</td><td>${Utils.formatCurrency(p.monto)}</td></tr>
                    `).join('') || '<tr><td colspan="4" class="text-center text-muted">Sin compras recientes</td></tr>';

                    // Últimas ventas
                    const salesBody = document.getElementById('recentSales');
                    salesBody.innerHTML = data.recentSales.map(s => `
                        <tr><td>#${s.id}</td><td>${Utils.escapeHtml(s.cliente || 'N/A')}</td><td>${Utils.formatDate(s.fecha)}</td><td>${Utils.formatCurrency(s.monto)}</td></tr>
                    `).join('') || '<tr><td colspan="4" class="text-center text-muted">Sin ventas recientes</td></tr>';
                }
            } catch (error) {
                console.error('Error cargando KPIs:', error);
                Utils.error('Error al cargar indicadores');
            }
        }

        // Cargar gráficos con filtro de año
        async function updateCharts(year) {
            try {
                // Si no se pasa año, obtener del selector o usar actual
                if (!year) {
                    year = document.getElementById('chartYear').value;
                }

                const chartsResult = await API.reports.getCharts({ year });

                if (chartsResult.success) {
                    // 1. Transacciones Mensuales
                    const monthlyData = chartsResult.data.monthlyTransactions;
                    const compras = new Array(12).fill(0);
                    const ventas = new Array(12).fill(0);

                    monthlyData.forEach(item => {
                        const monthIndex = item.mes - 1;
                        if (item.tipo === 'compra') {
                            compras[monthIndex] = item.total;
                        } else {
                            ventas[monthIndex] = item.total;
                        }
                    });

                    transactionsChart.data.datasets[0].data = compras;
                    transactionsChart.data.datasets[1].data = ventas;
                    transactionsChart.update();

                    // 2. Top Productos (Solo Top 5)
                    const topProducts = chartsResult.data.topProducts.slice(0, 5);
                    topProductsChart.data.labels = topProducts.map(p => p.nombre);
                    topProductsChart.data.datasets[0].data = topProducts.map(p => p.total_vendido);
                    topProductsChart.update();

                    // 3. Distribución Stock
                    // Nota: La distribución de stock suele ser snapshot actual, no histórica por año, 
                    // pero el endpoint getCharts devuelve stockDistribution basado en la consulta actual.
                    // Si el endpoint no filtra stock por año (que no tiene sentido), mostrará el actual.
                    const stockCounts = { Normal: 0, Bajo: 0, Exceso: 0 };
                    if (chartsResult.data.stockDistribution) {
                        chartsResult.data.stockDistribution.forEach(item => {
                            stockCounts[item.nivel] = item.cantidad;
                        });

                        stockDistChart.data.datasets[0].data = [
                            stockCounts['Normal'] || 0,
                            stockCounts['Bajo'] || 0,
                            stockCounts['Exceso'] || 0
                        ];
                        stockDistChart.update();
                    }
                }
            } catch (error) {
                console.error('Error cargando gráficos:', error);
                Utils.error('Error al cargar gráficos');
            }
        }

        // -------------------------------------------------------------
        // GESTIÓN DE TASA DÓLAR Y CACHÉ
        // -------------------------------------------------------------

        async function loadDollarRate() {
            const widget = document.getElementById('dollarWidget');
            const valueEl = document.getElementById('dollarValue');
            const CACHE_KEY = 'bcv_rate';
            const CACHE_TIME_KEY = 'bcv_rate_ts';
            const CACHE_DURATION = 4 * 60 * 60 * 1000; // 4 horas en milisegundos

            // 1. Intentar cargar de caché
            const cachedRate = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
            const now = Date.now();

            if (cachedRate && cachedTime) {
                const age = now - parseInt(cachedTime);
                if (age < CACHE_DURATION) {
                    // Caché válido
                    console.log('Usando tasa dólar en caché');
                    valueEl.textContent = `Bs. ${cachedRate}`;
                    widget.style.display = 'flex';
                    return;
                }
            }

            // 2. Si no hay caché válido, consultar API
            console.log('Consultando API tasa dólar...');
            valueEl.textContent = '...';
            widget.style.display = 'flex';

            try {
                const result = await API.reports.getDollarRate();

                if (result.success && result.rate) {
                    // Éxito: Mostrar y guardar en caché
                    valueEl.textContent = `Bs. ${result.formatted}`;
                    widget.classList.remove('error');

                    localStorage.setItem(CACHE_KEY, result.formatted);
                    localStorage.setItem(CACHE_TIME_KEY, now.toString());
                } else {
                    // Error manejado
                    throw new Error(result.message || 'No disponible');
                }
            } catch (error) {
                console.warn('Error obteniendo tasa:', error);
                valueEl.textContent = 'No disponible';
                widget.classList.add('error');
            }
        }

        // Event Listeners
        document.getElementById('chartYear').addEventListener('change', (e) => {
            updateCharts(e.target.value);
        });

        // Inicialización
        const currentYear = new Date().getFullYear();
        const yearSelect = document.getElementById('chartYear');
        if (yearSelect && yearSelect.querySelector(`option[value="${currentYear}"]`)) {
            yearSelect.value = currentYear;
        }

        initCharts();
        loadDashboardData();
        loadDollarRate(); // Carga con caché
        updateCharts(yearSelect ? yearSelect.value : currentYear);
    </script>
</body>

</html>