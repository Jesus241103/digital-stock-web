<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos | Digital Stock</title>

    <!-- Estilos -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layout.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar se inyecta vía JS (layout.js) -->

        <!-- Contenido -->

        <!-- Contenido -->
        <main class="main-content">
            <header class="main-header">
                <button class="mobile-menu-btn" id="menuBtn"><i class="fas fa-bars"></i></button>
                <div class="page-title-section">
                    <h1 class="page-title">Productos</h1>
                    <div class="page-breadcrumb">
                        <a href="dashboard.html">Inicio</a><span>/</span><span>Productos</span>
                    </div>
                </div>
                <div class="header-actions" id="adminActions" style="display: none;">
                    <button class="btn btn-primary" onclick="openProductModal()">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                </div>
            </header>

            <div class="content-area">
                <!-- Filtros -->
                <div class="filters-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por código o nombre...">
                    </div>
                    <select class="filter-select form-control" id="statusFilter" style="margin-right: 10px;">
                        <option value="1">Activos</option>
                        <option value="0">Inactivos</option>
                        <option value="">Todos los estados</option>
                    </select>
                    <select class="filter-select form-control" id="stockFilter">
                        <option value="">Todos los Niveles</option>
                        <option value="bajo">Stock bajo</option>
                        <option value="normal">Stock normal</option>
                        <option value="alto">Stock alto</option>
                        <option value="agotado">Agotado (Sin Stock)</option>
                    </select>
                </div>

                <!-- Tabla de productos -->
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Precio</th>
                                        <th>IVA</th>
                                        <th>Stock</th>
                                        <th>Mín/Máx</th>
                                        <th>Nivel Stock</th>
                                        <th class="admin-col">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productsBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted p-4">Cargando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Producto -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nuevo Producto</h3>
                <button class="modal-close" onclick="closeProductModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <div class="form-group">
                        <label class="form-label" for="productCodigo">Código (6 dígitos)</label>
                        <input type="text" class="form-control" id="productCodigo" maxlength="6" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="productNombre">Nombre</label>
                        <input type="text" class="form-control" id="productNombre" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label" for="productPrecio">Precio</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="productPrecio" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="productIva">IVA (%)</label>
                            <input type="number" step="0.01" min="0" max="100" class="form-control" id="productIva"
                                value="16" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label" for="productCantidad">Cantidad</label>
                            <input type="number" min="0" class="form-control" id="productCantidad" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="productMin">Mínimo</label>
                            <input type="number" min="0" class="form-control" id="productMin" value="5" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="productMax">Máximo</label>
                            <input type="number" min="1" class="form-control" id="productMax" value="100" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProductModal()">Cancelar</button>
                <button class="btn btn-primary" id="saveProductBtn" onclick="saveProduct()">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/layout.js"></script>
    <script>
        // Layout.js maneja la autenticación y UI global

        const user = API.getUser();
        const isAdmin = user && user.rol === 'admin';
        let editingCode = null;

        // Configurar UI específica de admin
        if (isAdmin) {
            document.getElementById('adminActions').style.display = 'flex';
        }

        // Ocultar columna acciones si no es admin
        if (!isAdmin) {
            document.querySelectorAll('.admin-col').forEach(el => el.style.display = 'none');
        }

        // Cargar productos
        async function loadProducts() {
            const search = document.getElementById('searchInput').value.trim();
            const stockFilter = document.getElementById('stockFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const params = {};
            if (search) params.search = search;
            if (statusFilter !== '') params.estado = statusFilter;

            const result = await API.products.getAll(params);
            const tbody = document.getElementById('productsBody');

            if (result.success && result.data.length > 0) {
                let products = result.data;

                // Filtrar por stock si es necesario
                if (stockFilter === 'bajo') {
                    products = products.filter(p => p.cantidad > 0 && p.cantidad <= p.min);
                } else if (stockFilter === 'normal') {
                    products = products.filter(p => p.cantidad > p.min && p.cantidad < p.max);
                } else if (stockFilter === 'alto') {
                    products = products.filter(p => p.cantidad >= p.max);
                } else if (stockFilter === 'agotado') {
                    products = products.filter(p => p.cantidad === 0);
                }

                tbody.innerHTML = products.map(p => {
                    let stockBadge = 'badge-success';
                    let stockText = 'Normal';

                    if (p.cantidad === 0) {
                        stockBadge = 'badge-exhausted';
                        stockText = 'Agotado';
                    } else if (p.cantidad <= p.min) {
                        stockBadge = 'badge-danger';
                        stockText = 'Bajo';
                    } else if (p.cantidad >= p.max) {
                        stockBadge = 'badge-warning';
                        stockText = 'Alto';
                    }

                    // Botón de acción dependiendo del estado
                    let actionBtn = '';
                    if (p.estado === 1) {
                        actionBtn = `
                            <button class="btn btn-ghost btn-sm text-danger" onclick="toggleStatus('${p.codigo}', 0)" title="Desactivar">
                                <i class="fas fa-trash"></i>
                            </button>`;
                    } else {
                        actionBtn = `
                            <button class="btn btn-ghost btn-sm text-success" onclick="toggleStatus('${p.codigo}', 1)" title="Activar">
                                <i class="fas fa-check"></i>
                            </button>`;
                    }

                    return `
                        <tr class="${p.estado === 0 ? 'opacity-50' : ''}">
                            <td><strong>${p.codigo}</strong></td>
                            <td>
                                ${Utils.escapeHtml(p.nombre)}
                                ${p.estado === 0 ? '<span class="badge badge-secondary ml-2" style="font-size: 0.7em;">Inactivo</span>' : ''}
                            </td>
                            <td>${Utils.formatCurrency(p.precio)}</td>
                            <td>${p.iva}%</td>
                            <td><strong>${p.cantidad}</strong></td>
                            <td>${p.min} / ${p.max}</td>
                            <td><span class="badge ${stockBadge}">${stockText}</span></td>
                            <td class="admin-col table-actions">
                                <button class="btn btn-ghost btn-sm" onclick="editProduct('${p.codigo}')" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${actionBtn}
                            </td>
                        </tr>
                    `;
                }).join('');

                if (!isAdmin) {
                    document.querySelectorAll('.admin-col').forEach(el => el.style.display = 'none');
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted p-4">No hay productos encontrados</td></tr>';
            }
        }

        // Buscar con debounce
        document.getElementById('searchInput').addEventListener('input', Utils.debounce(loadProducts, 300));
        document.getElementById('stockFilter').addEventListener('change', loadProducts);
        document.getElementById('statusFilter').addEventListener('change', loadProducts);

        // Modal
        function openProductModal(edit = false) {
            editingCode = null;
            document.getElementById('modalTitle').textContent = 'Nuevo Producto';
            document.getElementById('productForm').reset();
            document.getElementById('productCodigo').disabled = false;
            Utils.openModal('productModal');
        }

        function closeProductModal() {
            Utils.closeModal('productModal');
        }

        async function editProduct(codigo) {
            const result = await API.products.getByCode(codigo);
            if (result.success) {
                const p = result.data;
                editingCode = codigo;
                document.getElementById('modalTitle').textContent = 'Editar Producto';
                document.getElementById('productCodigo').value = p.codigo;
                document.getElementById('productCodigo').disabled = true;
                document.getElementById('productNombre').value = p.nombre;
                document.getElementById('productPrecio').value = parseFloat(p.precio).toFixed(2);
                document.getElementById('productIva').value = parseFloat(p.iva).toFixed(2);
                document.getElementById('productCantidad').value = p.cantidad;
                document.getElementById('productMin').value = p.min;
                document.getElementById('productMax').value = p.max;
                Utils.openModal('productModal');
            }
        }

        async function saveProduct() {
            const data = {
                codigo: document.getElementById('productCodigo').value,
                nombre: document.getElementById('productNombre').value,
                precio: document.getElementById('productPrecio').value,
                iva: document.getElementById('productIva').value,
                cantidad: document.getElementById('productCantidad').value || 0,
                min: document.getElementById('productMin').value,
                max: document.getElementById('productMax').value
            };

            // Validaciones
            if (!Utils.validateProductCode(data.codigo).valid && !editingCode) {
                Utils.error('El código debe ser de 6 dígitos');
                return;
            }

            if (parseInt(data.min) >= parseInt(data.max)) {
                Utils.error('El stock mínimo debe ser menor al máximo');
                return;
            }

            let result;
            if (editingCode) {
                result = await API.products.update(editingCode, data);
            } else {
                result = await API.products.create(data);
            }

            if (result.success) {
                Utils.success(result.message);
                closeProductModal();
                loadProducts();
            } else {
                Utils.error(result.message);
            }
        }

        async function toggleStatus(codigo, nuevoEstado) {
            const accion = nuevoEstado === 1 ? 'activar' : 'eliminar/desactivar';
            Utils.confirm(`¿Está seguro de ${accion} este producto?`, async () => {
                // Usamos update para cambiar el estado, ya que remove es soft-delete (estado=0)
                // Pero para reactivar necesitamos explicito update
                const result = await API.products.update(codigo, { estado: nuevoEstado });

                if (result.success) {
                    Utils.success(nuevoEstado === 1 ? 'Producto activado' : 'Producto desactivado');
                    loadProducts();
                } else {
                    Utils.error(result.message);
                }
            }, nuevoEstado === 1 ? 'Activar' : 'Eliminar');
        }

        // Iniciar
        loadProducts();
    </script>
</body>

</html>